# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: "Ozone Cluster Deployment"
  hosts: all
  gather_facts: false
  vars:
    # Expect cluster_mode to be passed in (non-ha | ha). Fallback to non-ha.
    cluster_mode: "{{ cluster_mode | default('non-ha') }}"
    ha_enabled: "{{ cluster_mode == 'ha' }}"
  pre_tasks:

    - name: "Pre-install: Gather facts"
      setup:

    - name: "Pre-install: Ensure Ansible remote tmp exists"
      file:
        path: "{{ (ansible_env.TMPDIR | default('/tmp')) ~ '/.ansible-' ~ ansible_user_id }}"
        state: directory
        mode: "0700"
        owner: "{{ ansible_user_id }}"

  roles:
    - role: cleanup
      tags: ["cleanup"]
      when: (do_cleanup | default(false))
    - role: ozone_user
      tags: ["ozone_user"]
    - role: ssh_bootstrap
      tags: ["ssh_bootstrap"]
    - role: java
      tags: ["java"]
    - role: ozone_layout
      tags: ["ozone_layout"]
    - role: ozone_fetch
      tags: ["ozone_fetch"]
    - role: ozone_config
      tags: ["ozone_config"]
    - role: ozone_service
      tags: ["ozone_service"]
      when: start_after_install | bool

- name: "Ozone Smoke Test"
  hosts: "{{ groups['om'] | list | first }}"
  gather_facts: false
  roles:
    - role: ozone_ui
      tags: ["ozone_ui"]
    - role: ozone_smoke
      tags: ["ozone_smoke"]

  post_tasks:
    - name: "Build UI endpoints display lines"
      set_fact:
        ui_display_lines: >-
          {{
            [
              '',
              '==========================================',
              '   Ozone Cluster UI Endpoints',
              '==========================================',
              '',
              'OM UI:'
            ] +
            (endpoint_urls.om | map('regex_replace', '^', '  - ') | list) +
            ['', 'SCM UI:'] +
            (endpoint_urls.scm | map('regex_replace', '^', '  - ') | list) +
            ['', 'Recon UI:'] +
            ((endpoint_urls.recon | length > 0) | ternary(
              endpoint_urls.recon | map('regex_replace', '^', '  - ') | list,
              ['  - Not configured']
            )) +
            ['', 'S3 Gateway (HTTP):'] +
            ((endpoint_urls.s3g_http | length > 0) | ternary(
              endpoint_urls.s3g_http | map('regex_replace', '^', '  - ') | list,
              ['  - Not configured']
            )) +
            ['', 'S3 Gateway (Admin):'] +
            ((endpoint_urls.s3g_admin | length > 0) | ternary(
              endpoint_urls.s3g_admin | map('regex_replace', '^', '  - ') | list,
              ['  - Not configured']
            )) +
            [
              '',
              '==========================================',
              'UI endpoints also saved to: ' ~ (controller_logs_dir | default('logs')) ~ '/endpoint_urls.json',
              '==========================================',
              ''
            ]
          }}
      run_once: true
      when: endpoint_urls is defined
      tags: ["always"]

    - name: "Display UI Endpoints Summary"
      debug:
        msg: "{{ ui_display_lines }}"
      run_once: true
      when: endpoint_urls is defined
      tags: ["always"]
