# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: "Check install_base presence"
  stat:
    path: "{{ install_base }}"
  register: _st_install_base
  become: true

- name: "Set presence flag"
  set_fact:
    install_present: "{{ _st_install_base.stat.exists | default(false) }}"

- name: "Skip cleanup when install_base is absent on this host"
  debug:
    msg: "install_base '{{ install_base }}' not present; skipping cleanup on this host"
  when: not install_present
  changed_when: false

- name: "Perform cleanup when install_base exists"
  when: install_present
  block:
    - name: "Set ozone bin path"
      set_fact:
        ozone_bin: "{{ install_base }}/current/bin/ozone"

    - name: "Kill OMs/SCMs/Datanodes/Recon (if running)"
      shell: |
        pkill -KILL -f "{{ item }}"
      become: true
      failed_when: false
      changed_when: false
      loop:
        - "org.apache.hadoop.ozone.om.OzoneManagerStarter"
        - "org.apache.hadoop.hdds.scm.server.StorageContainerManagerStarter"
        - "org.apache.hadoop.ozone.HddsDatanodeService"
        - "org.apache.hadoop.ozone.recon.ReconServer"
        - "org.apache.hadoop.ozone.s3.Gateway"
      loop_control:
        label: "{{ item }}"

    - name: "Remove install directory"
      file:
        path: "{{ install_base }}"
        state: absent
      become: true

    - name: "Remove data directory"
      file:
        path: "{{ data_base }}"
        state: absent
      become: true


